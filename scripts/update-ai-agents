#!/usr/bin/env bash

# AI Agents Updater Script
# Updates: claude code, codex, opencode, qwen coder, kimi code, aider, gemini, cursor, antigravity, kiro ide, kiro cli, windsurf

set -uo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m'
BOLD='\033[1m'
DIM='\033[2m'

# Counters
TOTAL_AGENTS=12
UPDATED=0
ALREADY_LATEST=0
SKIPPED=0
FAILED=0

# Detect OS/distro
detect_os() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        local id_like="${ID_LIKE:-}"
        if [[ "$ID" == "ubuntu" ]] || [[ "$ID" == "debian" ]] || [[ "$id_like" == *"debian"* ]] || [[ "$id_like" == *"ubuntu"* ]]; then
            echo "debian"
        elif [[ "$ID" == "arch" ]] || [[ "$id_like" == *"arch"* ]]; then
            echo "arch"
        else
            echo "unknown"
        fi
    else
        echo "unknown"
    fi
}

OS_TYPE=$(detect_os)

# Check if package is installed via system package manager
check_system_package() {
    local pkg_name=$1
    local os_type=$2

    case $os_type in
        "debian")
            dpkg -l "$pkg_name" 2>/dev/null | grep -q "^ii"
            ;;
        "arch")
            pacman -Q "$pkg_name" 2>/dev/null | grep -q "^$pkg_name"
            ;;
        *)
            return 1
            ;;
    esac
}

# Update system package
update_system_package() {
    local pkg_name=$1
    local os_type=$2

    case $os_type in
        "debian")
            echo -e "  ${DIM}Package manager:${NC} apt"
            echo -e "  ${DIM}Running:${NC} sudo apt update && sudo apt upgrade $pkg_name"
            sudo apt update 2>&1 | while read line; do
                echo -e "  ${DIM}>${NC} $line"
            done
            sudo apt upgrade -y "$pkg_name" 2>&1 | while read line; do
                echo -e "  ${DIM}>${NC} $line"
            done
            ;;
        "arch")
            if command -v yay &> /dev/null; then
                echo -e "  ${DIM}Package manager:${NC} yay (AUR helper)"
                echo -e "  ${DIM}Running:${NC} yay -Syu $pkg_name"
                yay -Syu --noconfirm "$pkg_name" 2>&1 | while read line; do
                    echo -e "  ${DIM}>${NC} $line"
                done
            elif command -v paru &> /dev/null; then
                echo -e "  ${DIM}Package manager:${NC} paru (AUR helper)"
                echo -e "  ${DIM}Running:${NC} paru -Syu $pkg_name"
                paru -Syu --noconfirm "$pkg_name" 2>&1 | while read line; do
                    echo -e "  ${DIM}>${NC} $line"
                done
            else
                echo -e "  ${DIM}Package manager:${NC} pacman"
                echo -e "  ${DIM}Running:${NC} sudo pacman -Syu $pkg_name"
                sudo pacman -Syu --noconfirm "$pkg_name" 2>&1 | while read line; do
                    echo -e "  ${DIM}>${NC} $line"
                done
            fi
            ;;
    esac
}

# Get version from command
get_version() {
    local cmd=$1
    $cmd --version 2>/dev/null | grep -oP '\d+\.\d+\.\d+' | head -1 || echo "unknown"
}

# Print agent header
print_agent_start() {
    local agent=$1
    local action=$2
    echo -e "\n${CYAN}${BOLD}â–¶${NC} ${BOLD}${agent}${NC} ${DIM}â†’${NC} ${action}"
}

# Print agent result
print_agent_result() {
    local status=$1
    local message=$2

    case $status in
        "updated")
            echo -e "  ${GREEN}âœ“${NC} ${GREEN}Updated${NC} ${message}"
            ;;
        "latest")
            echo -e "  ${BLUE}â—${NC} ${BLUE}Already latest${NC} ${message}"
            ;;
        "skipped")
            echo -e "  ${YELLOW}âŠ˜${NC} ${YELLOW}Not installed${NC}"
            ;;
        "failed")
            echo -e "  ${RED}âœ—${NC} ${RED}Failed${NC} ${message}"
            ;;
        "self-managed")
            echo -e "  ${MAGENTA}âš™${NC} ${MAGENTA}Self-managed${NC} ${message}"
            ;;
    esac
}

# Update functions

update_claude() {
    print_agent_start "Claude Code" "checking and updating"

    if command -v claude &> /dev/null; then
        echo -e "  ${DIM}Current:${NC} $(claude --version 2>/dev/null | head -1)"

        # Check if installed via package manager
        if check_system_package "claude-code" "$OS_TYPE" || check_system_package "claude" "$OS_TYPE"; then
            echo -e "  ${DIM}Installation:${NC} System package"
            local old_version=$(get_version "claude")
            update_system_package "claude-code" "$OS_TYPE"
            local new_version=$(get_version "claude")
            if [ "$old_version" != "$new_version" ] && [ "$new_version" != "unknown" ]; then
                print_agent_result "updated" "($old_version â†’ $new_version)"
                UPDATED=$((UPDATED + 1))
            else
                print_agent_result "latest" "($new_version)"
                ALREADY_LATEST=$((ALREADY_LATEST + 1))
            fi
        else
            echo -e "  ${DIM}Installation:${NC} Self-managed binary"
            echo -e "  ${DIM}Running:${NC} claude update"
            local old_version=$(get_version "claude")
            if claude update 2>&1 | grep -v "^$"; then
                local new_version=$(get_version "claude")
                if [ "$old_version" != "$new_version" ] && [ "$new_version" != "unknown" ]; then
                    print_agent_result "updated" "($old_version â†’ $new_version)"
                    UPDATED=$((UPDATED + 1))
                else
                    print_agent_result "latest" "($new_version)"
                    ALREADY_LATEST=$((ALREADY_LATEST + 1))
                fi
            else
                print_agent_result "failed" "(update command failed)"
                FAILED=$((FAILED + 1))
            fi
        fi
    else
        print_agent_result "skipped" ""
        SKIPPED=$((SKIPPED + 1))
    fi
}

update_codex() {
    print_agent_start "OpenAI Codex" "checking and updating"

    if command -v codex &> /dev/null; then
        echo -e "  ${DIM}Current:${NC} $(codex --version 2>/dev/null)"

        # Check if installed via package manager
        if check_system_package "codex" "$OS_TYPE" || check_system_package "openai-codex" "$OS_TYPE"; then
            echo -e "  ${DIM}Installation:${NC} System package"
            local old_version=$(get_version "codex")
            update_system_package "codex" "$OS_TYPE" || update_system_package "openai-codex" "$OS_TYPE"
            local new_version=$(get_version "codex")
            if [ "$old_version" != "$new_version" ] && [ "$new_version" != "unknown" ]; then
                print_agent_result "updated" "($old_version â†’ $new_version)"
                UPDATED=$((UPDATED + 1))
            else
                print_agent_result "latest" "($new_version)"
                ALREADY_LATEST=$((ALREADY_LATEST + 1))
            fi
        else
            echo -e "  ${DIM}Installation:${NC} npm global"
            echo -e "  ${DIM}Running:${NC} npm update -g @openai/codex"
            local old_version=$(get_version "codex")
            npm update -g @openai/codex 2>&1 | while read line; do
                echo -e "  ${DIM}>${NC} $line"
            done
            local new_version=$(get_version "codex")
            if [ "$old_version" != "$new_version" ] && [ "$new_version" != "unknown" ]; then
                print_agent_result "updated" "($old_version â†’ $new_version)"
                UPDATED=$((UPDATED + 1))
            else
                print_agent_result "latest" "($new_version)"
                ALREADY_LATEST=$((ALREADY_LATEST + 1))
            fi
        fi
    else
        print_agent_result "skipped" ""
        SKIPPED=$((SKIPPED + 1))
    fi
}

update_opencode() {
    print_agent_start "Opencode" "checking and updating"

    if command -v opencode &> /dev/null; then
        echo -e "  ${DIM}Current:${NC} $(opencode --version 2>/dev/null)"

        # Check if installed via package manager
        if check_system_package "opencode" "$OS_TYPE" || check_system_package "opencode-ai" "$OS_TYPE"; then
            echo -e "  ${DIM}Installation:${NC} System package"
            local old_version=$(get_version "opencode")
            update_system_package "opencode" "$OS_TYPE" || update_system_package "opencode-ai" "$OS_TYPE"
            local new_version=$(get_version "opencode")
            if [ "$old_version" != "$new_version" ] && [ "$new_version" != "unknown" ]; then
                print_agent_result "updated" "($old_version â†’ $new_version)"
                UPDATED=$((UPDATED + 1))
            else
                print_agent_result "latest" "($new_version)"
                ALREADY_LATEST=$((ALREADY_LATEST + 1))
            fi
        else
            echo -e "  ${DIM}Installation:${NC} Self-managed (npm)"
            echo -e "  ${DIM}Running:${NC} opencode upgrade"
            local old_version=$(get_version "opencode")
            opencode upgrade 2>&1 | while read line; do
                [ -n "$line" ] && echo -e "  ${DIM}>${NC} $line"
            done
            local new_version=$(get_version "opencode")
            if [ "$old_version" != "$new_version" ] && [ "$new_version" != "unknown" ]; then
                print_agent_result "updated" "($old_version â†’ $new_version)"
                UPDATED=$((UPDATED + 1))
            else
                print_agent_result "latest" "($new_version)"
                ALREADY_LATEST=$((ALREADY_LATEST + 1))
            fi
        fi
    else
        print_agent_result "skipped" ""
        SKIPPED=$((SKIPPED + 1))
    fi
}

update_qwen() {
    print_agent_start "Qwen Code" "checking and updating"

    if command -v qwen &> /dev/null; then
        echo -e "  ${DIM}Current:${NC} $(qwen --version 2>/dev/null)"

        # Check if installed via package manager
        if check_system_package "qwen" "$OS_TYPE" || check_system_package "qwen-code" "$OS_TYPE"; then
            echo -e "  ${DIM}Installation:${NC} System package"
            local old_version=$(get_version "qwen")
            update_system_package "qwen" "$OS_TYPE" || update_system_package "qwen-code" "$OS_TYPE"
            local new_version=$(get_version "qwen")
            if [ "$old_version" != "$new_version" ] && [ "$new_version" != "unknown" ]; then
                print_agent_result "updated" "($old_version â†’ $new_version)"
                UPDATED=$((UPDATED + 1))
            else
                print_agent_result "latest" "($new_version)"
                ALREADY_LATEST=$((ALREADY_LATEST + 1))
            fi
        else
            echo -e "  ${DIM}Installation:${NC} npm global"
            echo -e "  ${DIM}Running:${NC} npm update -g @qwen-code/qwen-code"
            local old_version=$(get_version "qwen")
            npm update -g @qwen-code/qwen-code 2>&1 | while read line; do
                echo -e "  ${DIM}>${NC} $line"
            done
            local new_version=$(get_version "qwen")
            if [ "$old_version" != "$new_version" ] && [ "$new_version" != "unknown" ]; then
                print_agent_result "updated" "($old_version â†’ $new_version)"
                UPDATED=$((UPDATED + 1))
            else
                print_agent_result "latest" "($new_version)"
                ALREADY_LATEST=$((ALREADY_LATEST + 1))
            fi
        fi
    else
        print_agent_result "skipped" ""
        SKIPPED=$((SKIPPED + 1))
    fi
}

update_gemini() {
    print_agent_start "Gemini CLI" "checking and updating"

    if command -v gemini &> /dev/null; then
        echo -e "  ${DIM}Current:${NC} $(gemini --version 2>/dev/null)"

        # Check if installed via package manager
        if check_system_package "gemini" "$OS_TYPE" || check_system_package "gemini-cli" "$OS_TYPE" || check_system_package "google-gemini-cli" "$OS_TYPE"; then
            echo -e "  ${DIM}Installation:${NC} System package"
            local old_version=$(get_version "gemini")
            update_system_package "gemini" "$OS_TYPE" || update_system_package "gemini-cli" "$OS_TYPE" || update_system_package "google-gemini-cli" "$OS_TYPE"
            local new_version=$(get_version "gemini")
            if [ "$old_version" != "$new_version" ] && [ "$new_version" != "unknown" ]; then
                print_agent_result "updated" "($old_version â†’ $new_version)"
                UPDATED=$((UPDATED + 1))
            else
                print_agent_result "latest" "($new_version)"
                ALREADY_LATEST=$((ALREADY_LATEST + 1))
            fi
        else
            echo -e "  ${DIM}Installation:${NC} npm global"
            echo -e "  ${DIM}Running:${NC} npm update -g @google/gemini-cli"
            local old_version=$(get_version "gemini")
            npm update -g @google/gemini-cli 2>&1 | while read line; do
                echo -e "  ${DIM}>${NC} $line"
            done
            local new_version=$(get_version "gemini")
            if [ "$old_version" != "$new_version" ] && [ "$new_version" != "unknown" ]; then
                print_agent_result "updated" "($old_version â†’ $new_version)"
                UPDATED=$((UPDATED + 1))
            else
                print_agent_result "latest" "($new_version)"
                ALREADY_LATEST=$((ALREADY_LATEST + 1))
            fi
        fi
    else
        print_agent_result "skipped" ""
        SKIPPED=$((SKIPPED + 1))
    fi
}

update_aider() {
    print_agent_start "Aider" "checking installation method"

    if command -v aider &> /dev/null; then
        echo -e "  ${DIM}Current:${NC} $(aider --version 2>/dev/null)"

        # Check if installed via package manager
        if check_system_package "aider" "$OS_TYPE" || check_system_package "aider-chat" "$OS_TYPE"; then
            echo -e "  ${DIM}Installation:${NC} System package"
            local old_version=$(get_version "aider")
            update_system_package "aider" "$OS_TYPE" || update_system_package "aider-chat" "$OS_TYPE"
            local new_version=$(get_version "aider")
            if [ "$old_version" != "$new_version" ] && [ "$new_version" != "unknown" ]; then
                print_agent_result "updated" "($old_version â†’ $new_version)"
                UPDATED=$((UPDATED + 1))
            else
                print_agent_result "latest" "($new_version)"
                ALREADY_LATEST=$((ALREADY_LATEST + 1))
            fi
        elif pipx list 2>/dev/null | grep -q "aider"; then
            echo -e "  ${DIM}Installation:${NC} pipx"
            echo -e "  ${DIM}Running:${NC} pipx upgrade aider-chat"
            local old_version=$(get_version "aider")
            pipx upgrade aider-chat 2>&1 | while read line; do
                echo -e "  ${DIM}>${NC} $line"
            done
            local new_version=$(get_version "aider")
            if [ "$old_version" != "$new_version" ] && [ "$new_version" != "unknown" ]; then
                print_agent_result "updated" "($old_version â†’ $new_version)"
                UPDATED=$((UPDATED + 1))
            else
                print_agent_result "latest" "($new_version)"
                ALREADY_LATEST=$((ALREADY_LATEST + 1))
            fi
        elif command -v uv &> /dev/null && uv tool list 2>/dev/null | grep -q "aider"; then
            echo -e "  ${DIM}Installation:${NC} uv"
            echo -e "  ${DIM}Running:${NC} uv tool upgrade aider-chat"
            local old_version=$(get_version "aider")
            uv tool upgrade aider-chat 2>&1 | while read line; do
                echo -e "  ${DIM}>${NC} $line"
            done
            local new_version=$(get_version "aider")
            if [ "$old_version" != "$new_version" ] && [ "$new_version" != "unknown" ]; then
                print_agent_result "updated" "($old_version â†’ $new_version)"
                UPDATED=$((UPDATED + 1))
            else
                print_agent_result "latest" "($new_version)"
                ALREADY_LATEST=$((ALREADY_LATEST + 1))
            fi
        else
            echo -e "  ${DIM}Installation:${NC} pip"
            echo -e "  ${DIM}Running:${NC} pip install --user --upgrade aider-chat"
            local old_version=$(get_version "aider")
            pip install --user --upgrade aider-chat 2>&1 | while read line; do
                echo -e "  ${DIM}>${NC} $line"
            done
            local new_version=$(get_version "aider")
            if [ "$old_version" != "$new_version" ] && [ "$new_version" != "unknown" ]; then
                print_agent_result "updated" "($old_version â†’ $new_version)"
                UPDATED=$((UPDATED + 1))
            else
                print_agent_result "latest" "($new_version)"
                ALREADY_LATEST=$((ALREADY_LATEST + 1))
            fi
        fi
    else
        print_agent_result "skipped" ""
        SKIPPED=$((SKIPPED + 1))
    fi
}

update_kimi() {
    print_agent_start "Kimi Code" "checking and updating"

    if command -v kimi &> /dev/null; then
        echo -e "  ${DIM}Current:${NC} $(kimi --version 2>/dev/null)"

        # Check if installed via uv tool (official install method from code.kimi.com/install.sh)
        if command -v uv &> /dev/null && uv tool list 2>/dev/null | grep -q "kimi-cli"; then
            echo -e "  ${DIM}Installation:${NC} uv tool (official)"
            echo -e "  ${DIM}Running:${NC} uv tool upgrade kimi-cli"
            local old_version=$(get_version "kimi")
            uv tool upgrade kimi-cli 2>&1 | while read line; do
                echo -e "  ${DIM}>${NC} $line"
            done
            local new_version=$(get_version "kimi")
            if [ "$old_version" != "$new_version" ] && [ "$new_version" != "unknown" ]; then
                print_agent_result "updated" "($old_version â†’ $new_version)"
                UPDATED=$((UPDATED + 1))
            else
                print_agent_result "latest" "($new_version)"
                ALREADY_LATEST=$((ALREADY_LATEST + 1))
            fi
        # Check if installed via package manager
        elif check_system_package "kimi" "$OS_TYPE" || check_system_package "kimi-code" "$OS_TYPE" || check_system_package "kimi-cli" "$OS_TYPE"; then
            echo -e "  ${DIM}Installation:${NC} System package"
            local old_version=$(get_version "kimi")
            update_system_package "kimi" "$OS_TYPE" || update_system_package "kimi-code" "$OS_TYPE" || update_system_package "kimi-cli" "$OS_TYPE"
            local new_version=$(get_version "kimi")
            if [ "$old_version" != "$new_version" ] && [ "$new_version" != "unknown" ]; then
                print_agent_result "updated" "($old_version â†’ $new_version)"
                UPDATED=$((UPDATED + 1))
            else
                print_agent_result "latest" "($new_version)"
                ALREADY_LATEST=$((ALREADY_LATEST + 1))
            fi
        # Check if installed via npm (legacy)
        elif npm list -g @kimi-ai/kimi-code 2>/dev/null | grep -q "kimi-code"; then
            echo -e "  ${DIM}Installation:${NC} npm global (legacy)"
            echo -e "  ${DIM}Running:${NC} npm update -g @kimi-ai/kimi-code"
            local old_version=$(get_version "kimi")
            npm update -g @kimi-ai/kimi-code 2>&1 | while read line; do
                echo -e "  ${DIM}>${NC} $line"
            done
            local new_version=$(get_version "kimi")
            if [ "$old_version" != "$new_version" ] && [ "$new_version" != "unknown" ]; then
                print_agent_result "updated" "($old_version â†’ $new_version)"
                UPDATED=$((UPDATED + 1))
            else
                print_agent_result "latest" "($new_version)"
                ALREADY_LATEST=$((ALREADY_LATEST + 1))
            fi
        else
            print_agent_result "self-managed" "(unknown installation method)"
        fi
    else
        print_agent_result "skipped" ""
        SKIPPED=$((SKIPPED + 1))
    fi
}

update_cursor() {
    print_agent_start "Cursor" "checking installation"

    if command -v cursor &> /dev/null; then
        # Check if installed via package manager
        if check_system_package "cursor" "$OS_TYPE"; then
            echo -e "  ${DIM}Installation:${NC} System package"
            local old_version=$(get_version "cursor")
            update_system_package "cursor" "$OS_TYPE"
            local new_version=$(get_version "cursor")
            if [ "$old_version" != "$new_version" ] && [ "$new_version" != "unknown" ]; then
                print_agent_result "updated" "($old_version â†’ $new_version)"
                UPDATED=$((UPDATED + 1))
            else
                print_agent_result "latest" "($new_version)"
                ALREADY_LATEST=$((ALREADY_LATEST + 1))
            fi
        else
            print_agent_result "self-managed" "(desktop app - check for updates in the application)"
        fi
    elif [ -f "$HOME/Applications/cursor/cursor" ] || [ -f "/opt/cursor/cursor" ]; then
        print_agent_result "self-managed" "(desktop app - check for updates in the application)"
    else
        print_agent_result "skipped" ""
        SKIPPED=$((SKIPPED + 1))
    fi
}

update_windsurf() {
    print_agent_start "Windsurf" "checking installation"

    if command -v windsurf &> /dev/null; then
        # Check if installed via package manager
        if check_system_package "windsurf" "$OS_TYPE"; then
            echo -e "  ${DIM}Installation:${NC} System package"
            local old_version=$(get_version "windsurf")
            update_system_package "windsurf" "$OS_TYPE"
            local new_version=$(get_version "windsurf")
            if [ "$old_version" != "$new_version" ] && [ "$new_version" != "unknown" ]; then
                print_agent_result "updated" "($old_version â†’ $new_version)"
                UPDATED=$((UPDATED + 1))
            else
                print_agent_result "latest" "($new_version)"
                ALREADY_LATEST=$((ALREADY_LATEST + 1))
            fi
        else
            print_agent_result "self-managed" "(desktop app - check for updates in the application)"
        fi
    elif [ -f "$HOME/Applications/Windsurf/windsurf" ] || [ -f "/opt/windsurf/windsurf" ]; then
        print_agent_result "self-managed" "(desktop app - check for updates in the application)"
    else
        print_agent_result "skipped" ""
        SKIPPED=$((SKIPPED + 1))
    fi
}

update_antigravity() {
    print_agent_start "Antigravity" "checking installation"

    if command -v antigravity &> /dev/null || [ -f "/usr/bin/antigravity" ]; then
        # Check if installed via package manager
        if check_system_package "antigravity" "$OS_TYPE"; then
            echo -e "  ${DIM}Installation:${NC} System package"
            local old_version=$(get_version "antigravity")
            update_system_package "antigravity" "$OS_TYPE"
            local new_version=$(get_version "antigravity")
            if [ "$old_version" != "$new_version" ] && [ "$new_version" != "unknown" ]; then
                print_agent_result "updated" "($old_version â†’ $new_version)"
                UPDATED=$((UPDATED + 1))
            else
                print_agent_result "latest" "($new_version)"
                ALREADY_LATEST=$((ALREADY_LATEST + 1))
            fi
        else
            print_agent_result "self-managed" "(system package - use your package manager: apt/pacman)"
        fi
    else
        print_agent_result "skipped" ""
        SKIPPED=$((SKIPPED + 1))
    fi
}

update_kiro() {
    print_agent_start "Kiro IDE" "checking installation"

    if command -v kiro &> /dev/null; then
        # Check if installed via package manager
        if check_system_package "kiro" "$OS_TYPE"; then
            echo -e "  ${DIM}Installation:${NC} System package"
            local old_version=$(get_version "kiro")
            update_system_package "kiro" "$OS_TYPE"
            local new_version=$(get_version "kiro")
            if [ "$old_version" != "$new_version" ] && [ "$new_version" != "unknown" ]; then
                print_agent_result "updated" "($old_version â†’ $new_version)"
                UPDATED=$((UPDATED + 1))
            else
                print_agent_result "latest" "($new_version)"
                ALREADY_LATEST=$((ALREADY_LATEST + 1))
            fi
        else
            print_agent_result "self-managed" "(Electron app - auto-updates or download from https://kiro.dev)"
        fi
    elif [ -f "$HOME/Applications/Kiro/kiro" ] || [ -f "/opt/kiro/kiro" ]; then
        print_agent_result "self-managed" "(Electron app - auto-updates or download from https://kiro.dev)"
    else
        print_agent_result "skipped" ""
        SKIPPED=$((SKIPPED + 1))
    fi
}

update_kiro_cli() {
    print_agent_start "Kiro CLI" "checking and updating"

    if command -v kiro-cli &> /dev/null; then
        echo -e "  ${DIM}Current:${NC} $(/home/vitor/.local/bin/kiro-cli --version 2>/dev/null)"
        echo -e "  ${DIM}Running:${NC} kiro-cli update"

        local old_version=$(/home/vitor/.local/bin/kiro-cli --version 2>/dev/null | grep -oP '\d+\.\d+\.\d+' | head -1 || echo "unknown")

        # Run update and capture output
        local output
        output=$(/home/vitor/.local/bin/kiro-cli update 2>&1)
        local exit_code=$?

        # Print output
        echo "$output" | while read line; do
            [ -n "$line" ] && echo -e "  ${DIM}>${NC} $line"
        done

        local new_version=$(/home/vitor/.local/bin/kiro-cli --version 2>/dev/null | grep -oP '\d+\.\d+\.\d+' | head -1 || echo "unknown")

        if [ $exit_code -eq 0 ]; then
            if [ "$old_version" != "$new_version" ] && [ "$new_version" != "unknown" ]; then
                print_agent_result "updated" "($old_version â†’ $new_version)"
                UPDATED=$((UPDATED + 1))
            else
                print_agent_result "latest" "($new_version)"
                ALREADY_LATEST=$((ALREADY_LATEST + 1))
            fi
        else
            print_agent_result "failed" "(update command failed with exit code $exit_code)"
            FAILED=$((FAILED + 1))
        fi
    else
        print_agent_result "skipped" ""
        SKIPPED=$((SKIPPED + 1))
    fi
}

# Show usage/help
show_help() {
    echo -e "\n${CYAN}${BOLD}AI Agents Updater${NC}"
    echo -e "${DIM}Updates AI coding agents installed on your system${NC}\n"
    echo -e "${BOLD}Usage:${NC}"
    echo -e "  update-ai-agents [TOOL]\n"
    echo -e "${BOLD}Options:${NC}"
    echo -e "  -h, --help     Show this help message\n"
    echo -e "${BOLD}Available tools:${NC}"
    echo -e "  all            Update all agents (default)"
    echo -e "  claude         Claude Code"
    echo -e "  codex          OpenAI Codex"
    echo -e "  opencode       Opencode"
    echo -e "  qwen           Qwen Code"
    echo -e "  gemini         Gemini CLI"
    echo -e "  aider          Aider"
    echo -e "  kimi           Kimi Code"
    echo -e "  cursor         Cursor"
    echo -e "  windsurf       Windsurf"
    echo -e "  antigravity    Antigravity"
    echo -e "  kiro           Kiro IDE"
    echo -e "  kiro-cli       Kiro CLI\n"
    echo -e "${BOLD}Examples:${NC}"
    echo -e "  update-ai-agents           # Update all agents"
    echo -e "  update-ai-agents claude    # Update only Claude Code"
    echo -e "  update-ai-agents codex     # Update only OpenAI Codex\n"
}

# Update single agent
update_single() {
    local tool=$1

    case $tool in
        claude)
            TOTAL_AGENTS=1
            update_claude
            ;;
        codex)
            TOTAL_AGENTS=1
            update_codex
            ;;
        opencode)
            TOTAL_AGENTS=1
            update_opencode
            ;;
        qwen)
            TOTAL_AGENTS=1
            update_qwen
            ;;
        gemini)
            TOTAL_AGENTS=1
            update_gemini
            ;;
        aider)
            TOTAL_AGENTS=1
            update_aider
            ;;
        kimi)
            TOTAL_AGENTS=1
            update_kimi
            ;;
        cursor)
            TOTAL_AGENTS=1
            update_cursor
            ;;
        windsurf)
            TOTAL_AGENTS=1
            update_windsurf
            ;;
        antigravity)
            TOTAL_AGENTS=1
            update_antigravity
            ;;
        kiro)
            TOTAL_AGENTS=1
            update_kiro
            ;;
        kiro-cli)
            TOTAL_AGENTS=1
            update_kiro_cli
            ;;
        *)
            echo -e "\n${RED}${BOLD}âœ— Error:${NC} Unknown tool '${tool}'"
            echo -e "${DIM}Run 'update-ai-agents --help' for available tools${NC}\n"
            exit 1
            ;;
    esac
}

# Main
main() {
    local arg="${1:-}"

    # Check for help flag
    if [[ "$arg" == "-h" ]] || [[ "$arg" == "--help" ]]; then
        show_help
        exit 0
    fi

    echo -e "\n${CYAN}${BOLD}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${CYAN}${BOLD}           ğŸ¤– AI AGENTS UPDATER${NC}"
    echo -e "${CYAN}${BOLD}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

    # If specific tool requested
    if [ $# -eq 1 ] && [[ "$arg" != "all" ]]; then
        echo -e "\n${DIM}Updating single agent:${NC} ${BOLD}$arg${NC}\n"
        update_single "$arg"
    else
        # Show OS info for all-agents mode
        if [ "$OS_TYPE" != "unknown" ]; then
            echo -e "\n${DIM}Detected OS:${NC} ${BOLD}$OS_TYPE${NC}"
            echo -e "${DIM}Will check and update ${TOTAL_AGENTS} AI agents...${NC}\n"
        else
            echo -e "\n${YELLOW}âš  Could not detect OS distribution${NC}"
            echo -e "${DIM}Will check and update ${TOTAL_AGENTS} AI agents...${NC}\n"
        fi

        update_claude
        update_codex
        update_opencode
        update_qwen
        update_gemini
        update_aider
        update_kimi
        update_cursor
        update_windsurf
        update_antigravity
        update_kiro
        update_kiro_cli
    fi

    # Summary
    echo -e "\n${CYAN}${BOLD}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${CYAN}${BOLD}           ğŸ“Š UPDATE SUMMARY${NC}"
    echo -e "${CYAN}${BOLD}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"

    [ $UPDATED -gt 0 ] && echo -e "${GREEN}${BOLD}âœ“ Updated:${NC}          ${UPDATED}"
    [ $ALREADY_LATEST -gt 0 ] && echo -e "${BLUE}${BOLD}â— Already latest:${NC}   ${ALREADY_LATEST}"
    [ $((TOTAL_AGENTS - UPDATED - SKIPPED - ALREADY_LATEST)) -gt 0 ] && echo -e "${MAGENTA}${BOLD}âš™ Self-managed:${NC}    $((TOTAL_AGENTS - UPDATED - SKIPPED - ALREADY_LATEST))"
    [ $SKIPPED -gt 0 ] && echo -e "${YELLOW}${BOLD}âŠ˜ Not installed:${NC}   ${SKIPPED}"
    [ $FAILED -gt 0 ] && echo -e "${RED}${BOLD}âœ— Failed:${NC}          ${FAILED}"

    echo -e "${BLUE}${BOLD}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo -e "${BOLD}Total agents:${NC}       ${TOTAL_AGENTS}\n"
}

main "$@"
