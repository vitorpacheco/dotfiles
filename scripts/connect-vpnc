#!/usr/bin/env bash
#
# VPNC Connection Script
# 
# Description: Connects to a VPN using vpnc with the specified profile.
#              Backs up DNS config and restores it on disconnect.
# 
# Usage: connect-vpnc <profile-name>
# 
# Requirements: vpnc, sudo access
# 
# Note: Run disconnect-vpnc to properly restore DNS configuration.
#

set -euo pipefail

if [[ $# -ne 1 ]]; then
  echo "Usage: $0 <profile-name>" >&2
  exit 1
fi

profile="$1"
conf="$HOME/.config/vpnc/${profile}.conf"

if [[ ! -f $conf ]]; then
  echo "Error: config file not found: $conf" >&2
  exit 1
fi

# Backup current DNS configuration
echo "ðŸ’¾ Backing up current DNS configuration..."
sudo cp /etc/resolv.conf /etc/resolv.conf.backup-vpn

echo "â³ Starting vpnc with profile '$profile'..."
sudo vpnc "$conf" --debug 3

# VPNC should have updated DNS, but let's verify and optionally override
echo "ðŸ” Current DNS configuration:"
cat /etc/resolv.conf

# Optional: Force specific DNS servers if needed
# Uncomment and modify these lines if you want to override:
# echo "ðŸ”§ Setting custom DNS servers..."
# echo "nameserver 192.168.1.1" | sudo tee /etc/resolv.conf > /dev/null
# echo "nameserver 8.8.8.8" | sudo tee -a /etc/resolv.conf > /dev/null
# echo "search company.local" | sudo tee -a /etc/resolv.conf > /dev/null

# Refresh DNS cache
if command -v resolvconf >/dev/null; then
  echo "ðŸ”„ Updating resolvconf..."
  sudo resolvconf -u
else
  echo "ðŸ”„ Flushing systemd-resolved cache..."
  sudo systemd-resolve --flush-caches || true
fi

echo "âœ… VPNC is up with DNS configured."
