#!/usr/bin/env bash
#
# Dotfiles Installation Script
# Supports: Ubuntu/Debian, Arch Linux, macOS
# Features: dry-run, logging, pre-flight checks, restore, health check
#

set -euo pipefail

# Source shared library
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/packages/lib.sh"

# --- Variables ---
DOTFILES_DIR="$SCRIPT_DIR"
CONFIG_DIR="$HOME/.config"
LOCAL_SCRIPTS_DIR="$HOME/.local/scripts"
LOG_FILE="$HOME/.dotfiles-install.log"
CHECKSUM_FILE="$CONFIG_DIR/.dotfiles-checksums"

# Initialize log file
echo "=== Dotfiles Install Log - $(date) ===" > "$LOG_FILE"

cd "$DOTFILES_DIR" || exit 1

# --- Flags ---
DRY_RUN=false
VERBOSE=false
PROFILE=""

# --- Help Function ---
show_help() {
  echo ""
  log_info "Dotfiles Installation Script"
  echo ""
  log_info "Usage: $(basename "$0") [OPTIONS]"
  echo ""
  log_info "Installs dotfiles and config files to your system."
  echo ""
  log_info "Options:"
  echo "  --help                       Show this help message and exit."
  echo "  --dry-run                    Preview changes without applying them."
  echo "  --verbose                    Enable verbose output."
  echo "  --profile=<minimal|full>     Use installation profile (minimal or full)."
  echo "  --check                      Verify installation health and report issues."
  echo "  --restore                    Restore all backed up files."
  echo ""
  log_info "Individual Installation Steps (use one or more):"
  echo "  --config             Install files from config-files/ to ~/.config/"
  echo "  --user-config        Install files/dirs from user-files/ to ~/"
  echo "  --installers         Execute scripts in installers/ (e.g., tmux, zsh, mise)"
  echo "  --packages           Execute scripts in packages/ (e.g., system packages)"
  echo "  --apps               Execute scripts in apps/ (e.g., Docker, Chrome)"
  echo "  --local-scripts      Symlink scripts from scripts/ to ~/.local/scripts/"
  echo "  --gnome              Execute scripts in gnome/ (GNOME desktop settings - Linux only)"
  echo "  --icons              Execute icons/install.sh (Linux only)"
  echo "  --omarchy-overrides  Install Omarchy-specific overrides only (tmux, hyprland)"
  echo ""
  log_info "Utility Scripts (from utils/):"
  echo "  --utils=\"script1.sh,script2.sh\" Execute specific utility scripts"
  echo ""
  log_info "Profiles:"
  echo "  --profile=minimal    Install only essential configs (zsh, git, tmux)"
  echo "  --profile=full       Install everything"
  echo "  --profile=omarchy    Install Omarchy overrides only (tmux, hyprland)"
  echo ""
  log_info "Platform Support:"
  echo "  - Linux (Ubuntu/Debian, Arch): Full support"
  echo "  - macOS: Most features supported (installers, packages, apps)"
  echo ""
  log_info "Examples:"
  echo "  ./install --dry-run --config        # Preview config installation"
  echo "  ./install --profile=minimal       # Minimal installation"
  echo "  ./install --profile=full          # Full installation"
  echo "  ./install --check                 # Check installation health"
  echo "  ./install --restore               # Restore backed up files"
  echo ""
}

# --- Pre-flight Checks ---
run_preflight_checks() {
  log_info "Running pre-flight checks..."

  local errors=0
  local warnings=0

  # Check OS
  local os
  if ! os=$(detect_os 2>/dev/null); then
    log_warn "Unknown or unsupported OS detected"
    log_info "Continuing anyway..."
    os="unknown"
    warnings=$((warnings + 1))
  fi

  log_info "Detected OS: $os"

  case "$os" in
    ubuntu|debian|arch|macos)
      log_success "OS is supported: $os"
      ;;
    unknown)
      log_warn "OS detection failed - some features may not work"
      ;;
    *)
      log_warn "OS may not be fully supported: $os"
      warnings=$((warnings + 1))
      ;;
  esac

  # Check essential commands
  local required_commands=("git" "bash" "ln")
  for cmd in "${required_commands[@]}"; do
    if ! check_command "$cmd"; then
      log_error "Required command not found: $cmd"
      errors=$((errors + 1))
    else
      log_debug "Found required command: $cmd"
    fi
  done

  # Check if in git repo
  if [[ ! -d "$DOTFILES_DIR/.git" ]]; then
    log_warn "Not a git repository. Some features may not work."
    warnings=$((warnings + 1))
  fi

  # Check dotfiles directory structure
  for dir in "config-files" "user-files" "scripts"; do
    if [[ ! -d "$DOTFILES_DIR/$dir" ]]; then
      log_error "Required directory not found: $dir"
      errors=$((errors + 1))
    fi
  done

  if [[ $errors -gt 0 ]]; then
    log_error "Pre-flight checks failed with $errors error(s). Please fix the issues above."
    exit 1
  fi

  if [[ $warnings -gt 0 ]]; then
    log_warn "Pre-flight checks completed with $warnings warning(s)"
  else
    log_success "Pre-flight checks passed"
  fi
}

# --- Check Installation Health ---
check_installation_health() {
  log_info "Checking installation health..."

  local issues=0

  # Check all symlinks in ~/.config
  if [[ -d "$CONFIG_DIR" ]]; then
    for item in "$CONFIG_DIR"/*; do
      if [[ -L "$item" ]]; then
        local target
        target=$(readlink "$item")
        if [[ ! -e "$target" ]]; then
          log_error "Broken symlink: $item -> $target"
          issues=$((issues + 1))
        else
          log_debug "Valid symlink: $item -> $target"
        fi
      fi
    done
  fi

  # Check symlinks in home directory
  for item in "$HOME"/.[^.]*; do
    if [[ -L "$item" ]]; then
      local target
      target=$(readlink "$item")
      if [[ "$target" == "$DOTFILES_DIR"* ]] && [[ ! -e "$target" ]]; then
        log_error "Broken dotfile symlink: $item -> $target"
        issues=$((issues + 1))
      fi
    fi
  done

  # Check local scripts
  if [[ -d "$LOCAL_SCRIPTS_DIR" ]]; then
    for item in "$LOCAL_SCRIPTS_DIR"/*; do
      if [[ -L "$item" ]]; then
        local target
        target=$(readlink "$item")
        if [[ ! -e "$target" ]]; then
          log_error "Broken script symlink: $item -> $target"
          issues=$((issues + 1))
        fi
      fi
    done
  fi

  # Check for manual modifications (if checksum file exists)
  if [[ -f "$CHECKSUM_FILE" ]]; then
    log_info "Checking for manual modifications..."
    while IFS= read -r line; do
      local file_path stored_checksum
      file_path=$(echo "$line" | cut -d' ' -f2)
      stored_checksum=$(echo "$line" | cut -d' ' -f1)

      if [[ -f "$file_path" ]] && [[ ! -L "$file_path" ]]; then
        local current_checksum
        if command -v md5sum >/dev/null 2>&1; then
          current_checksum=$(md5sum "$file_path" | cut -d' ' -f1)
        elif command -v md5 >/dev/null 2>&1; then
          current_checksum=$(md5 -q "$file_path")
        fi

        if [[ "$current_checksum" != "$stored_checksum" ]]; then
          log_warn "Manual modification detected: $file_path"
        fi
      fi
    done < "$CHECKSUM_FILE"
  fi

  if [[ $issues -eq 0 ]]; then
    log_success "Installation health check passed - no issues found"
  else
    log_error "Installation health check found $issues issue(s)"
  fi

  return $issues
}

# --- Restore Backups ---
restore_backups() {
  log_info "Restoring backed up files..."

  local restored=0

  # Restore config backups
  if [[ -d "$CONFIG_DIR" ]]; then
    for backup in "$CONFIG_DIR"/_*.backup*; do
      if [[ -e "$backup" ]]; then
        local original_name dest
        original_name=$(basename "$backup" | sed 's/^_//' | sed 's/\.backup.*$//')
        dest="$CONFIG_DIR/$original_name"

        if [[ "$DRY_RUN" == true ]]; then
          log_info "[DRY-RUN] Would restore: $backup -> $dest"
        else
          [[ -L "$dest" ]] && rm "$dest"
          mv "$backup" "$dest"
          log_success "Restored: $original_name"
          restored=$((restored + 1))
        fi
      fi
    done
  fi

  # Restore home directory backups
  for backup in "$HOME"/._*.backup*; do
    if [[ -e "$backup" ]]; then
      local original_name dest
      original_name=$(basename "$backup" | sed 's/^\.//' | sed 's/_//' | sed 's/\.backup.*$//')
      dest="$HOME/.$original_name"

      if [[ "$DRY_RUN" == true ]]; then
        log_info "[DRY-RUN] Would restore: $backup -> $dest"
      else
        [[ -L "$dest" ]] && rm "$dest"
        mv "$backup" "$dest"
        log_success "Restored: .$original_name"
        restored=$((restored + 1))
      fi
    fi
  done

  # Restore script backups
  if [[ -d "$LOCAL_SCRIPTS_DIR" ]]; then
    for backup in "$LOCAL_SCRIPTS_DIR"/_*.backup*; do
      if [[ -e "$backup" ]]; then
        local original_name dest
        original_name=$(basename "$backup" | sed 's/^_//' | sed 's/\.backup.*$//')
        dest="$LOCAL_SCRIPTS_DIR/$original_name"

        if [[ "$DRY_RUN" == true ]]; then
          log_info "[DRY-RUN] Would restore: $backup -> $dest"
        else
          [[ -L "$dest" ]] && rm "$dest"
          mv "$backup" "$dest"
          log_success "Restored script: $original_name"
          restored=$((restored + 1))
        fi
      fi
    done
  fi

  if [[ $restored -eq 0 ]]; then
    log_info "No backups found to restore"
  else
    log_success "Restored $restored file(s)"
  fi
}

# --- Checksum Functions ---
update_checksums() {
  log_debug "Updating checksums..."
  mkdir -p "$CONFIG_DIR"
  > "$CHECKSUM_FILE"

  # Calculate checksums for all config files
  for file in "$DOTFILES_DIR/config-files"/*; do
    if [[ -f "$file" ]]; then
      local checksum
      if command -v md5sum >/dev/null 2>&1; then
        checksum=$(md5sum "$file" | cut -d' ' -f1)
      elif command -v md5 >/dev/null 2>&1; then
        checksum=$(md5 -q "$file")
      fi
      echo "$checksum $CONFIG_DIR/$(basename "$file")" >> "$CHECKSUM_FILE"
    fi
  done

  log_debug "Checksums saved to $CHECKSUM_FILE"
}

# --- Utility Functions ---
backup_if_exists() {
  local path="$1"
  if [[ -e "$path" ]] && [[ ! -L "$path" ]]; then
    local backup_path="$(dirname "$path")/_$(basename "$path").backup"
    local counter=1
    while [[ -e "$backup_path" ]]; do
      backup_path="$(dirname "$path")/_$(basename "$path").backup.$counter"
      counter=$((counter + 1))
    done

    if [[ "$DRY_RUN" == true ]]; then
      log_info "[DRY-RUN] Would backup: $(basename "$path") -> $(basename "$backup_path")"
    else
      mv "$path" "$backup_path"
      log_info "Backed up: $(basename "$path") -> $(basename "$backup_path")"
    fi
  fi
}

create_symlink() {
  local source="$1"
  local dest="$2"

  if [[ "$DRY_RUN" == true ]]; then
    if [[ -L "$dest" ]] && [[ "$(readlink "$dest")" == "$source" ]]; then
      log_info "[DRY-RUN] Symlink already exists: $(basename "$dest")"
    else
      log_info "[DRY-RUN] Would create symlink: $(basename "$dest") -> $source"
    fi
  else
    if [[ -L "$dest" ]] && [[ "$(readlink "$dest")" == "$source" ]]; then
      log_success "Symlink already exists: $(basename "$dest")"
    else
      backup_if_exists "$dest"
      ln -s "$source" "$dest"
      log_success "Created symlink: $(basename "$dest")"
    fi
  fi
}

# --- Installation Sections ---

install_nvim_config() {
  log_info "Updating nvim submodule..."

  if [[ "$DRY_RUN" == false ]]; then
    git submodule update --init --recursive config-files/nvim 2>/dev/null || log_warn "Failed to update nvim submodule"
  fi

  local nvim_source="$DOTFILES_DIR/config-files/nvim"
  local nvim_dest="$CONFIG_DIR/nvim"

  if [[ -e "$nvim_source" ]]; then
    create_symlink "$nvim_source" "$nvim_dest"
  else
    log_warn "Nvim config submodule not found at $nvim_source"
  fi
}

install_config_files() {
  log_info "Installing config files to $CONFIG_DIR..."
  mkdir -p "$CONFIG_DIR"

  for file in "$DOTFILES_DIR/config-files"/*; do
    if [[ -e "$file" ]]; then
      local dest="$CONFIG_DIR/$(basename "$file")"
      create_symlink "$file" "$dest"
    fi
  done
}

install_user_config_files() {
  log_info "Installing user config files to $HOME..."

  for file in "$DOTFILES_DIR/user-files"/*; do
    local basename_file
    basename_file=$(basename "$file")

    if [[ "$basename_file" == "." ]] || [[ "$basename_file" == ".." ]]; then
      continue
    fi

    if [[ "$basename_file" == ".git" ]] || [[ "$basename_file" == ".tmux" ]]; then
      continue
    fi

    if [[ -e "$file" ]]; then
      local dest="$HOME/.$basename_file"
      create_symlink "$file" "$dest"
    fi
  done
}

execute_installers() {
  log_info "Executing installer scripts..."
  for script in "$DOTFILES_DIR/installers"/*.sh; do
    if [[ -f "$script" ]]; then
      if [[ "$DRY_RUN" == true ]]; then
        log_info "[DRY-RUN] Would execute: $(basename "$script")"
      else
        log_info "Executing $(basename "$script")..."
        bash "$script" || log_error "Failed to execute $(basename "$script")"
      fi
    fi
  done
}

install_packages() {
  log_info "Executing package installation scripts..."
  for script in "$DOTFILES_DIR/packages"/*.sh; do
    if [[ -f "$script" ]]; then
      if [[ "$DRY_RUN" == true ]]; then
        log_info "[DRY-RUN] Would execute: $(basename "$script")"
      else
        log_info "Executing $(basename "$script")..."
        bash "$script" || log_error "Failed to execute $(basename "$script")"
      fi
    fi
  done
}

install_apps() {
  log_info "Executing app installation scripts..."
  for script in "$DOTFILES_DIR/apps"/*.sh; do
    if [[ -f "$script" ]]; then
      if [[ "$DRY_RUN" == true ]]; then
        log_info "[DRY-RUN] Would execute: $(basename "$script")"
      else
        log_info "Executing $(basename "$script")..."
        bash "$script" || log_error "Failed to execute $(basename "$script")"
      fi
    fi
  done
}

install_gnome_scripts() {
  if is_macos; then
    log_info "GNOME scripts are Linux-only, skipping on macOS"
    return 0
  fi

  if is_gnome; then
    log_info "GNOME environment detected. Executing GNOME-specific scripts..."
    for script in "$DOTFILES_DIR/gnome"/*.sh; do
      if [[ -f "$script" ]]; then
        if [[ "$DRY_RUN" == true ]]; then
          log_info "[DRY-RUN] Would execute: $(basename "$script")"
        else
          log_info "Executing $(basename "$script")..."
          bash "$script" || log_error "Failed to execute $(basename "$script")"
        fi
      fi
    done
  else
    log_info "GNOME environment not detected. Skipping GNOME-specific scripts."
  fi
}

install_icons() {
  if is_macos; then
    log_info "Icon installation is Linux-only, skipping on macOS"
    return 0
  fi

  log_info "Executing icons installation script..."
  if [[ -f "$DOTFILES_DIR/icons/install.sh" ]]; then
    if [[ "$DRY_RUN" == true ]]; then
      log_info "[DRY-RUN] Would execute: icons/install.sh"
    else
      bash "$DOTFILES_DIR/icons/install.sh" || log_error "Failed to execute icons/install.sh"
    fi
  else
    log_warn "Icon installation script not found"
  fi
}

copy_local_scripts() {
  log_info "Symlinking local scripts to $LOCAL_SCRIPTS_DIR..."
  mkdir -p "$LOCAL_SCRIPTS_DIR"
  for script in "$DOTFILES_DIR/scripts"/*; do
    if [[ -e "$script" ]]; then
      local dest="$LOCAL_SCRIPTS_DIR/$(basename "$script")"
      create_symlink "$script" "$dest"
      if [[ "$DRY_RUN" == false ]]; then
        chmod +x "$dest" 2>/dev/null || true
      fi
    fi
  done
}

install_omarchy_overrides() {
  if ! is_omarchy; then
    log_warn "Omarchy system not detected. Skipping Omarchy overrides."
    return 0
  fi

  log_info "Installing Omarchy overrides..."

  # Install tmux overrides
  local tmux_override_source="$DOTFILES_DIR/config-files/tmux/omarchy-overrides.conf"
  local tmux_override_dest="$CONFIG_DIR/tmux/omarchy-overrides.conf"
  local tmux_system_conf="$CONFIG_DIR/tmux/tmux.conf"

  if [[ -f "$tmux_override_source" ]]; then
    if [[ "$DRY_RUN" == true ]]; then
      log_info "[DRY-RUN] Would create symlink: omarchy-overrides.conf"
    else
      create_symlink "$tmux_override_source" "$tmux_override_dest"
    fi
    
    # Add source line to system tmux.conf
    if [[ -f "$tmux_system_conf" ]]; then
      local tmux_source_line='# Source Omarchy overrides
if-shell "[ -f ~/.config/tmux/omarchy-overrides.conf ]" "source-file ~/.config/tmux/omarchy-overrides.conf"'
      
      if ! grep -q "omarchy-overrides.conf" "$tmux_system_conf" 2>/dev/null; then
        if [[ "$DRY_RUN" == true ]]; then
          log_info "[DRY-RUN] Would add source line to $tmux_system_conf"
        else
          echo "" >> "$tmux_system_conf"
          echo "$tmux_source_line" >> "$tmux_system_conf"
          log_success "Added source line to tmux.conf"
        fi
      else
        log_info "Source line already present in tmux.conf"
      fi
    fi
  else
    log_warn "tmux overrides file not found"
  fi

  # Install hyprland overrides
  local hypr_override_source="$DOTFILES_DIR/config-files/hypr/omarchy-overrides.conf"
  local hypr_override_dest="$CONFIG_DIR/hypr/omarchy-overrides.conf"
  local hypr_system_conf="$CONFIG_DIR/hypr/hyprland.conf"

  if [[ -f "$hypr_override_source" ]]; then
    if [[ "$DRY_RUN" == true ]]; then
      log_info "[DRY-RUN] Would create symlink: omarchy-overrides.conf"
    else
      create_symlink "$hypr_override_source" "$hypr_override_dest"
    fi
    
    # Add source line to system hyprland.conf
    if [[ -f "$hypr_system_conf" ]]; then
      local hypr_source_line='# Source Omarchy overrides
source = ./omarchy-overrides.conf'
      
      if ! grep -q "omarchy-overrides.conf" "$hypr_system_conf" 2>/dev/null; then
        if [[ "$DRY_RUN" == true ]]; then
          log_info "[DRY-RUN] Would add source line to $hypr_system_conf"
        else
          echo "" >> "$hypr_system_conf"
          echo "$hypr_source_line" >> "$hypr_system_conf"
          log_success "Added source line to hyprland.conf"
        fi
      else
        log_info "Source line already present in hyprland.conf"
      fi
    fi
  else
    log_warn "hyprland overrides file not found"
  fi

  log_success "Omarchy overrides installation complete"
}

execute_utils() {
  local scripts_to_execute="$1"
  if [[ -z "$scripts_to_execute" ]]; then
    log_info "No specific utility scripts requested."
    return
  fi

  log_info "Executing selected utility scripts: $scripts_to_execute"
  IFS=',' read -ra ADDR <<< "$scripts_to_execute"
  for i in "${ADDR[@]}"; do
    local script_path="$DOTFILES_DIR/utils/$i"
    if [[ -f "$script_path" ]]; then
      if [[ "$DRY_RUN" == true ]]; then
        log_info "[DRY-RUN] Would execute: $i"
      else
        log_info "Executing $i..."
        bash "$script_path" || log_error "Failed to execute $i"
      fi
    else
      log_error "Utility script not found: $i"
    fi
  done
}

# --- Main Logic ---

# Check if running on Omarchy
is_omarchy() {
  [[ -d "$HOME/.local/share/omarchy" ]] || [[ -f "/etc/omarchy-release" ]]
}

# Parse command line arguments
INSTALL_CONFIG=false
INSTALL_USER_CONFIG=false
INSTALL_APPS=false
INSTALL_GNOME=false
INSTALL_ICONS=false
INSTALL_INSTALLERS=false
INSTALL_PACKAGES=false
INSTALL_LOCAL_SCRIPTS=false
INSTALL_OMARCHY_OVERRIDES=false
CHECK_HEALTH=false
RESTORE=false
UTILITY_SCRIPTS=""
SHOW_HELP=false

for arg in "$@"; do
  case $arg in
    --help)
      SHOW_HELP=true
      ;;
    --dry-run)
      DRY_RUN=true
      log_info "Dry-run mode enabled - no changes will be made"
      ;;
    --verbose)
      VERBOSE=true
      export DEBUG=true
      ;;
    --check)
      CHECK_HEALTH=true
      ;;
    --restore)
      RESTORE=true
      ;;
    --profile=*)
      PROFILE="${arg#*=}"
      ;;
    --config)
      INSTALL_CONFIG=true
      ;;
    --user-config)
      INSTALL_USER_CONFIG=true
      ;;
    --apps)
      INSTALL_APPS=true
      ;;
    --gnome)
      INSTALL_GNOME=true
      ;;
    --icons)
      INSTALL_ICONS=true
      ;;
    --installers)
      INSTALL_INSTALLERS=true
      ;;
    --packages)
      INSTALL_PACKAGES=true
      ;;
    --local-scripts)
      INSTALL_LOCAL_SCRIPTS=true
      ;;
    --omarchy-overrides)
      INSTALL_OMARCHY_OVERRIDES=true
      ;;
    --utils=*)
      UTILITY_SCRIPTS="${arg#*=}"
      ;;
    *)
      log_error "Unknown argument: $arg"
      show_help
      exit 1
      ;;
  esac
done

# Handle special commands
if [[ "$SHOW_HELP" == true ]]; then
  show_help
  exit 0
fi

if [[ "$CHECK_HEALTH" == true ]]; then
  check_installation_health
  exit $?
fi

if [[ "$RESTORE" == true ]]; then
  restore_backups
  exit 0
fi

# Run pre-flight checks
if [[ "$DRY_RUN" == false ]]; then
  run_preflight_checks
fi

# Apply profiles if specified
if [[ -n "$PROFILE" ]]; then
  case $PROFILE in
    minimal)
      log_info "Using minimal profile"
      INSTALL_CONFIG=true
      INSTALL_USER_CONFIG=true
      INSTALL_LOCAL_SCRIPTS=true
      ;;
    full)
      log_info "Using full profile"
      INSTALL_CONFIG=true
      INSTALL_USER_CONFIG=true
      INSTALL_INSTALLERS=true
      INSTALL_PACKAGES=true
      INSTALL_APPS=true
      INSTALL_LOCAL_SCRIPTS=true
      INSTALL_GNOME=true
      INSTALL_ICONS=true
      ;;
    omarchy)
      log_info "Using omarchy profile - installing overrides only"
      INSTALL_OMARCHY_OVERRIDES=true
      INSTALL_LOCAL_SCRIPTS=true
      ;;
    *)
      log_error "Unknown profile: $PROFILE. Use 'minimal' or 'full'"
      exit 1
      ;;
  esac
fi

# Execute sections based on flags
if [[ "$INSTALL_CONFIG" == true ]]; then
  install_nvim_config
  install_config_files
fi

if [[ "$INSTALL_USER_CONFIG" == true ]]; then
  install_user_config_files
fi

if [[ "$INSTALL_INSTALLERS" == true ]]; then
  execute_installers
fi

if [[ "$INSTALL_PACKAGES" == true ]]; then
  install_packages
fi

if [[ "$INSTALL_APPS" == true ]]; then
  install_apps
fi

if [[ "$INSTALL_GNOME" == true ]]; then
  install_gnome_scripts
fi

if [[ "$INSTALL_ICONS" == true ]]; then
  install_icons
fi

if [[ "$INSTALL_LOCAL_SCRIPTS" == true ]]; then
  copy_local_scripts
fi

if [[ "$INSTALL_OMARCHY_OVERRIDES" == true ]]; then
  install_omarchy_overrides
fi

execute_utils "$UTILITY_SCRIPTS"

# Update checksums after installation
if [[ "$DRY_RUN" == false ]] && [[ "$INSTALL_CONFIG" == true ]]; then
  update_checksums
fi

log_success "Dotfiles installation complete!"
log_info "Log file saved to: $LOG_FILE"

# vi: ft=bash
